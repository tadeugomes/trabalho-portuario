---
title: "Mercado de Trabalho no Setor Portuário - Maranhão"
output: 
  html_document:
    keep_tex: true
    fig_width: 12
    fig_height: 8
    fig_align: "center"
---


```{r, results='hide', include=FALSE}
# install.packages(c("basedosdados", "tidyverse", "dbplyr",
# "scales", "ggrepel"))

library(basedosdados)
library(tidyverse)
library(dbplyr)
library(scales)
library(ggrepel)
library(ggtext)

# aqui você define o seu projeto billing_id
basedosdados::set_billing_id("porto-ma")
```

# Trabalhadores de Operações Portuárias
```{r, eval=FALSE, include=FALSE}
#### Dados da RAIS para operacoes portuarias 
query <- c("
  SELECT sigla_uf, cnae_2_subclasse, tipo_vinculo, valor_remuneracao_media, sexo, grau_instrucao_apos_2005, cbo_2002
  FROM `basedosdados.br_me_rais.microdados_vinculos`
  WHERE (vinculo_ativo_3112 = 1) 
      AND (ano = 2020) 
      AND (cnae_2_subclasse = '5231101' OR cnae_2_subclasse = '5231102')")

# lendo a query do chuck anterior
rais <- read_sql(query)

# criando o arquivo csv
write_csv(rais, file = "rais.csv")
```


```{r import-data, include=FALSE}
rais <- read.csv(file = "rais.csv")

```

```{r, include=FALSE}

#alterando levels das variáveis
rais <- rais %>% 
  mutate( 
    sigla_uf = fct_reorder(sigla_uf, desc(sigla_uf)), 
    sexo = ifelse(sexo == 1, "Homem", "Mulher"), 
    grau_instrucao_apos_2005 = factor( 
      case_when( 
        grau_instrucao_apos_2005 %in% 1:4 ~ "Fundamental incompleto", 
        grau_instrucao_apos_2005 == 5 ~ "Fundamental completo", 
        grau_instrucao_apos_2005 == 6 ~ "Médio incompleto", 
        grau_instrucao_apos_2005 == 7 ~ "Médio completo",
        grau_instrucao_apos_2005 == 8 ~ "Superior incompleto", 
        grau_instrucao_apos_2005 == 9 ~ "Superior completo", 
        grau_instrucao_apos_2005 == 10 ~ "Pós-graduação", 
        grau_instrucao_apos_2005 == -1 ~ "Não informado"
      ), 
      levels = c( 
        "Fundamental incompleto", "Fundamental completo", 
        "Médio incompleto", "Médio completo", "Superior incompleto",
        "Superior completo", "Pós-graduação", "Não informado"
      ) 
    ))

```


```{r, results='hide', echo=FALSE, message=FALSE, warning=FALSE}
rais %>%
  filter(cnae_2_subclasse == "5231102") %>% 
  group_by(sigla_uf) %>% 
  summarise(n = n()) %>% 
  mutate(sigla_uf = fct_reorder(sigla_uf, n),
         fill = ifelse(sigla_uf == "MA", "um", "dois")) %>%
ggplot(aes(x = sigla_uf, y = n,
           fill = fill, 
           size = .5))+
  geom_bar(position = "dodge", stat = "identity") +
  coord_flip() +
  labs(x = "UF", y = "Número de vínculos",
         caption = "Fonte: Observatório Portuário do Maranhão - Dados da RAIS 2000") +
  ggtitle(
    "Empregados na Operação de Terminais Portuários por estado", 
    subtitle = str_c(
      "São",
      rais %>% filter(cnae_2_subclasse == "5231102") %>% group_by(sigla_uf) %>% 
    summarise(n = n()) %>% select(n) %>% sum() %>% comma(big.mark = ".", decimal.mark = ","),
      "vínculos de trabalho em todo o país",
      sep = " ")) +
theme_classic() +
  theme(plot.title = element_text(size = 16L, face = "bold"),
        plot.caption = element_text(size = 10L,face = "bold", hjust = 0), 
        axis.title.y = element_text(size = 10L, face = "bold"), 
        axis.title.x = element_text(size = 10L, face = "bold"),
        panel.grid.major.x  = element_line(color = "black", linetype = 3, size = 0.1),
        legend.position = "none")+
  geom_text(aes(label= prettyNum(n, big.mark = ".", decimal.mark = ",")), 
            size =2.5,  
            hjust=-.01, vjust=0.5, colour="black") +
  scale_fill_manual(values = c("lightblue", "#4682B4")) +
  scale_y_continuous(breaks = seq(0,12000, 3000), limits = c(0, 12000),
                     labels = number_format(big.mark = ".", decimal.mark = ","))
  
```


# Administração da Infraestrutura Portuária

```{r, results='hide', echo=FALSE, message=FALSE, warning=FALSE}
rais %>%
  filter(cnae_2_subclasse == "5231101") %>% 
  group_by(sigla_uf) %>% 
  summarise(n = n()) %>% 
  mutate(sigla_uf = fct_reorder(sigla_uf, n),
         fill = ifelse(sigla_uf == "MA", "um", "dois")) %>%
ggplot(aes(x = sigla_uf, y = n,
           fill = fill, 
           size = .5))+
  geom_bar(stat="identity") +
  coord_flip() +
  labs(x = "UF", y = "Número de vínculos",
         caption = "Fonte: Observatório Portuário do Maranhão - Dados da RAIS 2000") +
  ggtitle(
    "Empregados na Operação de Terminais Portuários por estado", 
    subtitle = str_c(
      "São",
      rais %>% filter(cnae_2_subclasse == "5231101") %>% group_by(sigla_uf) %>% 
    summarise(n = n()) %>% select(n) %>% sum() %>% comma(big.mark = ".", decimal.mark = ","),
      "vínculos de trabalho em todo o país",
      sep = " ")) +
theme_classic() +
  theme(plot.title = element_text(size = 16L, face = "bold"),
        plot.caption = element_text(size = 10L,face = "bold", hjust = 0), 
        axis.title.y = element_text(size = 10L, face = "bold"), 
        axis.title.x = element_text(size = 10L, face = "bold"),
        panel.grid.major.x  = element_line(color = "black", linetype = 3, size = 0.1),
        legend.position = "none")+
  geom_text(aes(label= prettyNum(n, big.mark = ".", decimal.mark = ",")), 
            size =2.5,  
            hjust=-.01, vjust=0.5, colour="black") +
  scale_fill_manual(values = c("lightblue", "#4682B4")) +
  scale_y_continuous(breaks = seq(0,1200, 300), limits = c(0, 1200),
                     labels = number_format(big.mark = ".", decimal.mark = ","))
  
```

```{r, results='hide', echo=FALSE, message=FALSE, warning=FALSE}
ordem <- c("Fundamental incompleto", "Fundamental completo", 
        "Médio incompleto", "Médio completo", "Superior incompleto",
        "Superior completo", "Pós-graduação", "Não informado")

rais %>%
  filter(!is.na(grau_instrucao_apos_2005) & cnae_2_subclasse == "5231101") %>%
  group_by(grau_instrucao_apos_2005, sexo) %>% 
  summarise(n = n()) %>% 
  mutate(grau_instrucao_apos_2005 = factor(grau_instrucao_apos_2005, levels = ordem)) %>%
  ggplot(aes(x = grau_instrucao_apos_2005, y = n, fill = sexo)) +
  geom_bar(stat = "identity", 
          position=position_dodge(), 
           show.legend = T, color = "black") +
  labs(title = " Escolaridade dos profissionais que atuam na Operação\nde Terminais Portuários no Brasil por sexo",
       x = "Grau de instrução", y = "Número de vínculos",
       caption = "Fonte: Observatório Portuário do Maranhão - Dados da RAIS 2000") +
  coord_flip() +
  theme_classic() +
  theme(plot.title = element_text(size = 16L, face = "bold"),
        plot.caption = element_text(size = 10L,face = "bold", hjust = 0), 
        axis.title.y = element_text(size = 10L, face = "bold"), 
        axis.title.x = element_text(size = 10L, face = "bold"),
        panel.grid.major.x  = element_line(color = "black", linetype = 3, size = 0.1),
        legend.position="top",
        legend.title = element_text(face = "bold")
        )+
  geom_text_repel(aes(x = grau_instrucao_apos_2005, y = n, label= prettyNum(n, big.mark = ".", decimal.mark = ",")),
            position = position_dodge(width = 1),
            size =2.5, vjust=1.5,
           colour="black") +
  scale_y_continuous(breaks = seq(0,1400, 700), limits = c(0, 1400),
                     labels = number_format(big.mark = ".", decimal.mark = ",")) +
  scale_fill_manual(values = alpha(c("#7777DD", "#CC6666"), .7), name = "Sexo")

```

