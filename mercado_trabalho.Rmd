---
title: "Mercado de Trabalho no Setor Portuário - Maranhão"
author: "Observatório Portuário do Maranhão"
output:
  html_document:
    toc: true
    number_sections: true
    toc_float: true
    collapsed: true
    smooth_scroll: true
    toc_depth: 2
    keep_tex: yes
    fig_width: 12
    fig_height: 8
    fig_caption: true
    fig_align: center
    theme: cerulean
    highlight: kate
---


<style type="text/css">

body{ /* Normal  */
      font-size: 12px;
  }
td {  /* Table  */
  font-size: 8px;
}
h1.title {
  font-size: 38px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>


```{r setup, include=FALSE, results='hide'}

if (!require("pacman")) install.packages("pacman")
pacman::p_load("basedosdados", "tidyverse", 
               "dbplyr", "scales")


# aqui você define o seu projeto billing_id
basedosdados::set_billing_id("porto-ma")
```

```{r query, eval=FALSE, include=FALSE}
#### Dados da RAIS para operacoes portuarias 
query <- c("
  SELECT --selecionando as seguintes colunas
    sigla_uf, --Sigla da Unidade da Federação
    ano, --Ano
    subsetor_ibge, --Subsetor - IBGE
    nacionalidade, --Nacionalidade
  	tipo_vinculo, --Tipo do Vínculo
  	cnae_2_subclasse, --Classificação Nacional de Atividades Econômicas (CNAE) 2.0 Subclasse
  	valor_remuneracao_media, --Valor da Remuneração Média
  	sexo, --Sexo
  	raca_cor, --Raça ou cor
  	grau_instrucao_apos_2005, 
  	cbo_2002, --Classificação Brasileira de Ocupações (CBO) 2002
  	id_municipio --ID Município - IBGE 7 Dígitos
  FROM `basedosdados.br_me_rais.microdados_vinculos` --da tabela
  WHERE --onde
      (vinculo_ativo_3112 = 1)
      AND (ano BETWEEN 2010 AND 2020) 
      AND cnae_2_subclasse  IN (
      --esssas duas subclasses são da divisão 50 TRANSPORTE AQUAVIÁRIO
      '5231101', --Administração da infraestrutura portuária
      '5231102', --Atividades do operador portuário
      --esssas outras são novas
      '5011401', --Transporte marítimo de cabotagem - carga
      '5011402', --Transporte marítimo de cabotagem - passageiros
      '5021101', --Transporte por navegação interior de carga, municipal, exceto travessia
      '5021102', --Transporte por navegação interior de carga, intermunicipal, interestadual e internacional, exceto travessia
      '5022001', --Transporte por navegação interior de passageiros em linhas regulares, municipal, exceto travessia
      '5022002', --Transporte por navegação interior de passageiros em linhas regulares, intermunicipal, interestadual e internacional, exceto travessia
      '5030101', --Navegação de apoio marítimo
      '5030102', --Navegação de apoio portuário
      '5030103', --Serviço de rebocadores e empurradores
      '5091201', --Transporte por navegação de travessia, municipal
      '5091202', --Transporte por navegação de travessia intermunicipal, interestadual e internacional
      '5099801', --Transporte aquaviário para passeios turísticos
      '5099899' --Outros transportes aquaviários não especificados anteriormente
  )")

#Baixando o dicionário
query1 <- c("SELECT * --seleciona todas as colunas
            FROM `basedosdados.br_me_rais.dicionario` --basedosdados.<NOME DO CONJUNTO DE DADOS>.<NOME DA TABELA>.")
# lendo os dados da rais da base dos dados
rais <- read_sql(query)

# lendo o dicionário dos dados da rais da base dos dados
dic <- read_sql(query1)

# criando os arquivos csv
write_csv(rais, file = "dados/rais.csv")
write_csv(dic, file = "dados/dicionario.csv")
```

```{r importando_arquivos, context="data", include=FALSE}
#lendo os dados da rais
rais <- read_csv(file = "dados/rais.csv",
                 col_type = list(.default = "f",
                                 valor_remuneracao_media = "d"))

#lendo o dicionário dos dados da rais
dic <- read_csv(file = "dados/dicionario.csv",
                 col_type = list(.default = "f"))

#lendo arquivo da cbo 2002
cbo <- read_delim(file = 'dados/cbo2002.csv', delim = ";",
                col_type = list(.default = "f"),
                locale = locale(encoding = "latin1"))

#lendo dados dos municípios 
municipios <- readxl::read_xls(
  'dados/municipios_ibge.xls',
  col_names = c("cod_uf", "nome_uf", 
                "cod_rg_intermedia", "nome_rg_intermediaria",
                "cod_rg_imediata", "nome_rg_imediata", 
                "cod_mesorregiao", "nome_mesorregiao", 
                "cod_microrregiao", "nome_microrregiao",
                "cod_municipio", "cod_municipio_completo", "nome_municipio"),
  skip = 1)

#lendo dados das subclasses da cnae
subclasses <- readxl::read_xls(
  "dados/cnae_subclasse.xls",
  col_names = c("secao", "divisao", "grupo", 
                "classe", "subclasse", "denominacao"),
  skip = 5
)

```


```{r limpando_subclasse, context="data", include=FALSE}

#definindo vetor de letras maiúsculas
letras <- LETTERS[seq(1, 26)]

# filtrando a coluna secao pelas letras que identificão as seções
# e por linhas que possuam valores NA
#isso buscar retirar os cabeçalhos do arquivos cnae_subclasse.xls
subclasses <- 
subclasses %>% 
  filter(secao %in% letras | is.na(secao))

# selecionando APENAS as seções da cnae
secao <- 
  subclasses %>% 
  filter(!is.na(secao)) %>% 
  select(secao, denominacao) %>% 
  rename(n_secao = denominacao)

# selecionando APENAS as divisões da cnae
divisao <- 
  subclasses %>% 
  filter(!is.na(divisao)) %>% 
  select(divisao, denominacao) %>% 
  rename(n_divisao = denominacao)

# selecionando APENAS as grupos da cnae
grupo <- 
  subclasses %>% 
  filter(!is.na(grupo)) %>% 
  select(grupo, denominacao) %>% 
  rename(n_grupo = denominacao)

# selecionando APENAS as classes da cnae
classe <- 
  subclasses %>% 
  filter(!is.na(classe)) %>% 
  select(classe, denominacao) %>% 
  rename(n_classe = denominacao)


# autocompletando as colunas para baixo
subclasses <- 
subclasses %>% 
  fill(secao:classe, .direction = "down")

# filtrando tudo aquilo que não é NA coluna subclasse
#tabela limpa
subclasses <- 
subclasses %>% 
  filter(!is.na(subclasse))

#renomeando a coluna denominacao
subclasses <- 
subclasses %>% 
  rename(n_subclasse = denominacao)

################## Fazendo o join #################
#da tabela secao com a tabela subclasses
subclasses  <- 
  left_join(subclasses, #primeira tabela
          secao, #segunda tabela
          by = "secao")

#da tabela divisao com a tabela subclasses
subclasses  <- 
  left_join(subclasses, #primeira tabela
          divisao, #segunda tabela
          by = "divisao")

#da tabela grupo com a tabela subclasses
subclasses  <- 
  left_join(subclasses, #primeira tabela
          grupo, #segunda tabela
          by = "grupo")

#da tabela classe com a tabela subclasses
subclasses  <- 
  left_join(subclasses, #primeira tabela
          classe, #segunda tabela
          by = "classe")

# substituindo todas as pontuações por nada das colunas
#grupo, classe, subclasse
subclasses <-
subclasses %>% 
  mutate_at(.vars = vars("grupo", "classe", "subclasse"), .funs = ~str_replace_all(., "[:punct:]", ""))

#alteradno o tipo de todas as colunas para fator
subclasses <- subclasses %>% mutate(across(everything(), as.factor))
```


```{r limpando, context="data", include=FALSE}
#alterando o tipo de todas as colunas da tabela municipio para fator
municipios <- municipios %>% mutate(across(everything(), as.factor))

# substituindo o valor 517235 por 517335 da coluna CODIGO da tabela cbo
cbo <- 
cbo %>% mutate(
  CODIGO = as.character(CODIGO),
  CODIGO = if_else(CODIGO == "517235", "517335", CODIGO),
  CODIGO = as.factor(CODIGO))

```

```{r joins_niveis, include=FALSE}

#alterando levels das variáveis

#juntando as tabelas rais e municipios
rais <- 
  left_join(rais, #primeira tabela
          municipios, #segunda tabela
          by = c("id_municipio" = "cod_municipio_completo")) %>% 
  select(!id_municipio & !starts_with("cod_"))

#da variáveil sexo
rais <- 
  left_join(rais, #primeira tabela
          dic %>% #segunda tabela
            filter(nome_coluna == "sexo") %>% 
            select(c("chave", "valor")),
          by = c("sexo" = "chave")) %>% 
  mutate(sexo = valor) %>% #substituindo sexo
  select(!valor)
          
rais <- 
rais %>% 
  mutate(
    grau_instrucao_apos_2005 = factor( 
        case_when( 
          grau_instrucao_apos_2005 %in% 1:4 ~ "Fundamental incompleto", 
          grau_instrucao_apos_2005 == 5 ~ "Fundamental completo", 
          grau_instrucao_apos_2005 == 6 ~ "Médio incompleto", 
          grau_instrucao_apos_2005 == 7 ~ "Médio completo",
          grau_instrucao_apos_2005 == 8 ~ "Superior incompleto", 
          grau_instrucao_apos_2005 == 9 ~ "Superior completo", 
          grau_instrucao_apos_2005 == 10 ~ "Pós-graduação", 
          grau_instrucao_apos_2005 == -1 ~ "Não informado"
        ), 
        levels = c( 
          "Fundamental incompleto", "Fundamental completo", 
          "Médio incompleto", "Médio completo", "Superior incompleto",
          "Superior completo", "Pós-graduação", "Não informado"
        ) 
      )
    )

#da variáveil cbo_2002
rais <- 
  left_join(rais, #primeira tabela
          cbo, #segunda tabela
          by = c("cbo_2002" = "CODIGO")) %>% 
  mutate(cbo_2002 = TITULO) %>% #substituindo 
  select(!TITULO)
          
#da variáveil raca_cor
rais <- 
  left_join(rais, #primeira tabela
          dic %>% #segunda tabela
            filter(nome_coluna == "raca_cor") %>% 
            select(c("chave", "valor")),
          by = c("raca_cor" = "chave")) %>% 
  mutate(raca_cor = valor) %>% #substituindo raca_Cor
  select(!valor)

#da variável tabela rais com a tabela subclasses
# e excluindo a coluna cnae_2_subclasse
rais <- 
  left_join(
    rais, #primeira tabela
    subclasses, #segunda tabela
    by = c("cnae_2_subclasse" = "subclasse"),
    keep = T) %>% 
  select(!cnae_2_subclasse)

```

# Trabalhadores de Operações Portuárias

```{r n_grupo_cnae, include=FALSE, results='hide'}
dn <-
rais %>%
  group_by(n_grupo, ano) %>% 
  summarise(n = n()) %>% 
  mutate(n_grupo = fct_reorder(n_grupo, n)) %>% 
  arrange(desc(n)) %>% 
  top_n(10)
```


```{r g_denominacao,  echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
dn %>%
  filter(!is.na(n_grupo)) %>% 
ggplot(aes(x = ano, y = n, group = n_grupo)) +
  geom_line(aes(color = n_grupo), size = 2) +
  geom_point(aes(color = n_grupo), size = 4) +
  labs(x = "Ocupação", y = "Número de vínculos",
         caption = "Fonte: Observatório Portuário do Maranhão - Dados da RAIS 2020") +
  theme_classic() +
  theme(plot.title = element_text(size = 16L, face = "bold"),
        plot.caption = element_text(size = 12L,face = "bold", hjust = 0), 
        axis.title.y = element_text(size = 14L, face = "bold"), 
        axis.title.x = element_text(size = 14L, face = "bold"),
        axis.text.x = element_text(size = 12L, face = "bold"),
        axis.text.y = element_text(size = 12L, face = "bold"),
        legend.text = element_text(size = 14L),
        panel.grid.major.x  = element_line(color = "black", linetype = 3, size = 0.1,),
        legend.position = "top",
        legend.justification = c("left", "top"),
        legend.title = element_text(size = 16L, face = "bold")) +
  scale_colour_discrete(name = str_wrap("Grupos da CNAE", 10), labels = label_wrap_gen(width = 18))
  
```
```{r dados_uf, include=FALSE, results='hide'}
uf <-
rais %>%
  filter(subclasse == "5231102") %>% 
  group_by(sigla_uf) %>% 
  summarise(n = n()) %>% 
  mutate(sigla_uf = fct_reorder(sigla_uf, n),
         fill = ifelse(sigla_uf == "MA", "um", "dois")) %>% 
  arrange(desc(n))
```


O Brasil apresentou `r rais %>% filter(subclasse == "5231102") %>% group_by(sigla_uf) %>% 
    summarise(n = n()) %>% select(n) %>% sum() %>% comma(big.mark = ".", decimal.mark = ",")` vínculos de trabalho para a subclasse **Operações de Terminais**. São Paulo foi o estado com a maior quantidade de vínculos, ao todo foram `r uf %>% filter(n == max(n)) %>% select(n) %>% pull() %>% comma(big.mark = ".", decimal.mark = ",")` vínculos no estado. Rio de Janeiro, segundo estado com a maior quantidade de vículos, possuía cerca de `r uf %>% filter(n == nth(n, 2)) %>% select(n) %>% pull() %>% comma(big.mark = ".", decimal.mark = ",")`. O estado do Maranhão possuía `r uf %>% filter(sigla_uf == "MA") %>% select(n) %>% pull()  %>% comma(big.mark = ".", decimal.mark = ",")` vínculos.

```{r g_operacao_uf,  echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
uf %>%
ggplot(aes(x = sigla_uf, y = n,
           fill = fill, 
           size = .5))+
  geom_bar(position = "dodge", stat = "identity") +
  coord_flip() +
  labs(x = "Ocupação", y = "Número de vínculos",
         caption = "Fonte: Observatório Portuário do Maranhão - Dados da RAIS 2020") +
  ggtitle(
    "Empregados na Operação de Terminais Portuários por estado", 
    subtitle = str_c(
      "São",
      rais %>% filter(subclasse == "5231102") %>% group_by(sigla_uf) %>% 
    summarise(n = n()) %>% select(n) %>% sum() %>% comma(big.mark = ".", decimal.mark = ","),
      "vínculos de trabalho em todo o país",
      sep = " ")) +
theme_classic() +
  theme(plot.title = element_text(size = 16L, face = "bold"),
        plot.caption = element_text(size = 12L,face = "bold", hjust = 0), 
        axis.title.y = element_text(size = 14L, face = "bold"), 
        axis.title.x = element_text(size = 14L, face = "bold"),
        axis.text.x = element_text(size = 12L, face = "bold"),
        axis.text.y = element_text(size = 12L, face = "bold"),
        panel.grid.major.x  = element_line(color = "black", linetype = 3, size = 0.1),
        legend.position = "none")+
  geom_text(aes(label= prettyNum(n, big.mark = ".", decimal.mark = ",")), 
            size =4,  
            hjust=-.5, vjust=.5, colour="black") +
  scale_fill_manual(values = c("lightblue", "#4682B4")) +
  scale_y_continuous(breaks = seq(0,12000, 3000), limits = c(0, 12000),
                     labels = number_format(big.mark = ".", decimal.mark = ","))
       
```

## Escolaridade

```{r g_operacao_escol_sexo, results='hide', echo=FALSE, message=FALSE, warning=FALSE}
ordem_esc <- c("Fundamental incompleto", "Fundamental completo", 
        "Médio incompleto", "Médio completo", "Superior incompleto",
        "Superior completo", "Pós-graduação", "Não informado")

rais %>%
  filter(!is.na(grau_instrucao_apos_2005) & subclasse == "5231102") %>%
  group_by(grau_instrucao_apos_2005, sexo, .groups = 'drop') %>% 
  summarise(n = n()) %>% 
  mutate(grau_instrucao_apos_2005 = factor(grau_instrucao_apos_2005, levels = ordem_esc)) %>%
  ggplot(aes(x = grau_instrucao_apos_2005, y = n, fill = sexo)) +
  geom_bar(stat = "identity", 
          position=position_dodge2(reverse = TRUE), 
           show.legend = T, color = "black") +
  labs(title = "Escolaridade dos profissionais que atuam na Operação de Terminais Portuários no Brasil\npor sexo",
       x = "Grau de instrução", y = "Número de vínculos",
       caption = "Fonte: Observatório Portuário do Maranhão - Dados da RAIS 2020") +
  coord_flip() +
  theme_classic() +
  theme(plot.title = element_text(size = 16L, face = "bold"),
        plot.caption = element_text(size = 12L,face = "bold", hjust = 0), 
        axis.title.y = element_text(size = 14L, face = "bold"), 
        axis.title.x = element_text(size = 14L, face = "bold"),
        axis.text.x = element_text(size = 12L, face = "bold"),
        axis.text.y = element_text(size = 12L, face = "bold"),
        panel.grid.major.x  = element_line(color = "black", linetype = 3, size = 0.1),
        legend.position="top",
        legend.title = element_text(face = "bold")
        )+
  geom_text(aes(x = grau_instrucao_apos_2005, y = n, label= prettyNum(n, big.mark = ".", decimal.mark = ",")),
            position = position_dodge2(width = 1, reverse = TRUE),
            size =4, vjust=.25, hjust = -.1,
           colour="black") +
  scale_y_continuous(breaks = seq(0,20000, 5000), limits = c(0, 20000),
                     labels = number_format(big.mark = ".", decimal.mark = ",")) +
  scale_fill_manual(values = alpha(c("#32cdc2", "#FFBF47"), 1), name = "Sexo")

```

```{r g_operacao_remuneracao_escol_sexo, results='hide', echo=FALSE, message=FALSE, warning=FALSE}

rais %>%
  filter(!is.na(grau_instrucao_apos_2005) & valor_remuneracao_media != 0.00  & subclasse == "5231102") %>%
  group_by(grau_instrucao_apos_2005, sexo, .groups = 'drop') %>% 
  summarise(n = n(),
            media = mean(valor_remuneracao_media)) %>% 
  mutate(grau_instrucao_apos_2005 = factor(grau_instrucao_apos_2005, levels = ordem_esc)) %>%
  ggplot(aes(x = grau_instrucao_apos_2005, y = media, fill = sexo)) +
  geom_bar(stat = "identity", 
          position=position_dodge2(reverse = T), 
           show.legend = T, color = "black") +
  labs(title = "Remuneração média dos profissionais que atuam na Operaçãode Terminais Portuários\nno Brasil por grau de escolaridade e sexo",
       x = "Grau de instrução", y = "Remuneração media",
       caption = "Fonte: Observatório Portuário do Maranhão - Dados da RAIS 2020") +
  coord_flip() +
  theme_classic() +
  theme(plot.title = element_text(size = 16L, face = "bold"),
        plot.caption = element_text(size = 12L,face = "bold", hjust = 0), 
        axis.title.y = element_text(size = 14L, face = "bold"), 
        axis.title.x = element_text(size = 14L, face = "bold"),
        axis.text.x = element_text(size = 12L, face = "bold"),
        axis.text.y = element_text(size = 12L, face = "bold"),
        panel.grid.major.x  = element_line(color = "black", linetype = 3, size = 0.1),
        legend.position="top",
        legend.title = element_text(face = "bold")
        )+
  geom_text(aes(x = grau_instrucao_apos_2005, y = media, label= prettyNum(media, big.mark = ".", decimal.mark = ",", digits = 1)),
            position = position_dodge2(width = 1, reverse = T),
            size =4, vjust=.25, hjust = -.25,
           colour="black") +
  scale_y_continuous(
    breaks = seq(0,15000, 5000), limits = c(0, 15000),
    labels = label_number(big.mark = ".", decimal.mark = ",",
                                            prefix = "R$ ")) +
  scale_fill_manual(values = alpha(c("#32cdc2", "#FFBF47"), 1), name = "Sexo")

```


## Raça ou cor

```{r g_operacao_raca_sexo, results='hide', echo=FALSE, message=FALSE, warning=FALSE}

rais %>%
  filter(subclasse == "5231102") %>%
  group_by(raca_cor, sexo, .groups = 'drop') %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = raca_cor, y = n, fill = sexo)) +
  geom_bar(stat = "identity", 
          position=position_dodge2(reverse = TRUE), 
           show.legend = T, color = "black") +
  labs(title = "Quantidade dos profissionais que atuam na Operação de Terminais Portuários no Brasil\npor raça ou cor e sexo",
       x = "Raça ou cor", y = "Número de vínculos",
       caption = "Fonte: Observatório Portuário do Maranhão - Dados da RAIS 2020") +
  coord_flip() +
  theme_classic() +
  theme(plot.title = element_text(size = 16L, face = "bold"),
        plot.caption = element_text(size = 12L,face = "bold", hjust = 0), 
        axis.title.y = element_text(size = 14L, face = "bold"), 
        axis.title.x = element_text(size = 14L, face = "bold"),
        axis.text.x = element_text(size = 12L, face = "bold"),
        axis.text.y = element_text(size = 12L, face = "bold"),
        panel.grid.major.x  = element_line(color = "black", linetype = 3, size = 0.1),
        legend.position="top",
        legend.title = element_text(face = "bold")
        )+
  geom_text(aes(x = raca_cor, y = n, label= prettyNum(n, big.mark = ".", decimal.mark = ",")),
            position = position_dodge2(width = 1, reverse = TRUE),
            size =4, vjust=.25, hjust = -.1,
           colour="black") +
  scale_y_continuous(breaks = seq(0,20000, 5000), limits = c(0, 20000),
                     labels = number_format(big.mark = ".", decimal.mark = ",")) +
  scale_fill_manual(values = alpha(c("#32cdc2", "#FFBF47"), 1), name = "Sexo")

```


```{r g_operacao_remuneracao_raca_sexo, results='hide', echo=FALSE, message=FALSE, warning=FALSE}

rais %>%
  filter(valor_remuneracao_media != 0.00  & subclasse == "5231102") %>%
  group_by(raca_cor, sexo, .groups = 'drop') %>% 
  summarise(n = n(),
            media = mean(valor_remuneracao_media)) %>% 
  ggplot(aes(x = raca_cor, y = media, fill = sexo)) +
  geom_bar(stat = "identity", 
          position=position_dodge2(reverse = T), 
           show.legend = T, color = "black") +
  labs(title = "Remuneração média dos profissionais que atuam na Operação de Terminais Portuários no Brasil\npor grau de escolaridade e raça ou cor",
       x = "Raça ou cor", y = "Remuneração média",
       caption = "Fonte: Observatório Portuário do Maranhão - Dados da RAIS 2020") +
  coord_flip() +
  theme_classic() +
  theme(plot.title = element_text(size = 16L, face = "bold"),
        plot.caption = element_text(size = 12L,face = "bold", hjust = 0), 
        axis.title.y = element_text(size = 14L, face = "bold"), 
        axis.title.x = element_text(size = 14L, face = "bold"),
        axis.text.x = element_text(size = 12L, face = "bold"),
        axis.text.y = element_text(size = 12L, face = "bold"),
        panel.grid.major.x  = element_line(color = "black", linetype = 3, size = 0.1),
        legend.position="top",
        legend.title = element_text(face = "bold")
        )+
  geom_text(aes(x = raca_cor, y = media, label= prettyNum(media, big.mark = ".", decimal.mark = ",", digits = 1)),
            position = position_dodge2(width = 1, reverse = T),
            size =4, vjust=.25, hjust = -.25,
           colour="black") +
  scale_y_continuous(
    breaks = seq(0,20000, 5000), limits = c(0, 20000),
    labels = label_number(big.mark = ".", decimal.mark = ",",
                                            prefix = "R$ ")) +
  scale_fill_manual(values = alpha(c("#32cdc2", "#FFBF47"), 1), name = "Raça ou cor")

```

## Ocupações

```{r g_operacao_ocupacao, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
rais %>%
  filter(subclasse == "5231102") %>% 
  group_by(cbo_2002) %>% 
  summarise(n = n()) %>% 
  mutate(cbo_2002 = fct_reorder(cbo_2002, n)) %>% 
  arrange(desc(n)) %>% 
  top_n(10, n) %>% 
  ggplot(aes(x = cbo_2002, y = n))+
  geom_bar(fill = "lightblue", color = "black", position = "dodge", stat = "identity") +
  coord_flip() +
  labs(x = "Ocupação", y = "Número de vínculos",
         caption = "Fonte: Observatório Portuário do Maranhão - Dados da RAIS 2020") +
  ggtitle(
    "As 10 ocpupações  com a maior quantidade de vínculos na Operação de\n Terminais Portuários", 
    subtitle = str_c(
      "São",
      rais %>% filter(subclasse == "5231102") %>% group_by(cbo_2002) %>% 
    summarise(n = n()) %>% select(n) %>% sum() %>% comma(big.mark = ".", decimal.mark = ","),
      "vínculos de trabalho em todo o país",
      sep = " ")) +
theme_classic() +
  theme(plot.title = element_text(size = 16L, face = "bold"),
        plot.caption = element_text(size = 12L,face = "bold", hjust = 0), 
        axis.title.y = element_text(size = 14L, face = "bold"), 
        axis.title.x = element_text(size = 14L, face = "bold"),
        axis.text.x = element_text(size = 12L, face = "bold"),
        axis.text.y = element_text(size = 12L, face = "bold"),
        panel.grid.major.x  = element_line(color = "black", linetype = 3, size = 0.1),
        legend.position = "none")+
  geom_text(aes(label= prettyNum(n, big.mark = ".", decimal.mark = ",")), 
            size =4,  
            hjust=2, vjust=0.5, colour="black") +
  scale_y_continuous(breaks = seq(0,2500, 500), limits = c(0, 2500),
                     labels = number_format(big.mark = ".", decimal.mark = ","))
  
```

## Municípios

```{r g_operacao_municipio, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
rais %>%
  filter(subclasse == "5231102") %>% 
  group_by(nome_municipio) %>% 
  summarise(n = n()) %>% 
  mutate(nome_municipio = fct_reorder(nome_municipio, n)) %>% 
  arrange(desc(n)) %>% 
  top_n(20, n) %>% 
  ggplot(aes(x = nome_municipio, y = n))+
  geom_bar(fill = "lightblue", color = "black", position = "dodge", stat = "identity") +
  coord_flip() +
  labs(x = "Nome do município", y = "Número de vínculos",
         caption = "Fonte: Observatório Portuário do Maranhão - Dados da RAIS 2020") +
  ggtitle(
    "Os 20 municípios  com a maior quantidade de vínculos na Operação de\n Terminais Portuários", 
    subtitle = str_c(
      "São",
      rais %>% filter(subclasse == "5231102") %>% group_by(cbo_2002) %>% 
    summarise(n = n()) %>% select(n) %>% sum() %>% comma(big.mark = ".", decimal.mark = ","),
      "vínculos de trabalho em todo o país",
      sep = " ")) +
theme_classic() +
  theme(plot.title = element_text(size = 16L, face = "bold"),
        plot.caption = element_text(size = 12L,face = "bold", hjust = 0), 
        axis.title.y = element_text(size = 14L, face = "bold"), 
        axis.title.x = element_text(size = 14L, face = "bold"),
        axis.text.x = element_text(size = 12L, face = "bold"),
        axis.text.y = element_text(size = 12L, face = "bold"),
        panel.grid.major.x  = element_line(color = "black", linetype = 3, size = 0.1),
        legend.position = "none")+
  geom_text(aes(label= prettyNum(n, big.mark = ".", decimal.mark = ",")), 
            size =4,  
            hjust=1.5, vjust=0.5, colour="black") +
  scale_y_continuous(breaks = seq(0,6000, 2000), limits = c(0, 8000),
                     labels = number_format(big.mark = ".", decimal.mark = ","))
  
```

# Administração da Infraestrutura Portuária

```{r g_adm_uf, results='hide', echo=FALSE, message=FALSE, warning=FALSE}
rais %>%
  filter(subclasse == "5231101") %>% 
  group_by(sigla_uf) %>% 
  summarise(n = n()) %>% 
  mutate(sigla_uf = fct_reorder(sigla_uf, n),
         fill = ifelse(sigla_uf == "MA", "um", "dois")) %>%
ggplot(aes(x = sigla_uf, y = n,
           fill = fill, 
           size = .5))+
  geom_bar(stat="identity") +
  coord_flip() +
  labs(x = "UF", y = "Número de vínculos",
         caption = "Fonte: Observatório Portuário do Maranhão - Dados da RAIS 2020") +
  ggtitle(
    "Empregados na Administração da Infraestrura Portuária por estado", 
    subtitle = str_c(
      "São",
      rais %>% filter(subclasse == "5231101") %>% group_by(sigla_uf) %>% 
    summarise(n = n()) %>% select(n) %>% sum() %>% comma(big.mark = ".", decimal.mark = ","),
      "vínculos de trabalho em todo o país",
      sep = " ")) +
theme_classic() +
  theme(plot.title = element_text(size = 16L, face = "bold"),
        plot.caption = element_text(size = 12L,face = "bold", hjust = 0), 
        axis.title.y = element_text(size = 14L, face = "bold"), 
        axis.title.x = element_text(size = 14L, face = "bold"),
        axis.text.x = element_text(size = 12L, face = "bold"),
        axis.text.y = element_text(size = 12L, face = "bold"),
        panel.grid.major.x  = element_line(color = "black", linetype = 3, size = 0.1),
        legend.position = "none")+
  geom_text(aes(label= prettyNum(n, big.mark = ".", decimal.mark = ",")), 
            size =4,  
            hjust=-.5, vjust=0.5, colour="black") +
  scale_fill_manual(values = c("lightblue", "#4682B4")) +
  scale_y_continuous(breaks = seq(0,1200, 300), limits = c(0, 1200),
                     labels = number_format(big.mark = ".", decimal.mark = ","))
  
```

## Escolaridade

```{r g_adm_escol_sexo, results='hide', echo=FALSE, message=FALSE, warning=FALSE}

rais %>%
  filter(!is.na(grau_instrucao_apos_2005) & subclasse == "5231101") %>%
  group_by(grau_instrucao_apos_2005, sexo, .groups = 'drop') %>% 
  summarise(n = n()) %>% 
  mutate(grau_instrucao_apos_2005 = factor(grau_instrucao_apos_2005, levels = ordem_esc)) %>%
  ggplot(aes(x = grau_instrucao_apos_2005, y = n, fill = sexo)) +
  geom_bar(stat = "identity", 
          position=position_dodge2(reverse = T), 
           show.legend = T, color = "black") +
  labs(title = "Escolaridade dos profissionais que atuam na Administração da Infraestrutura Portuária\nno Brasil por sexo",
       x = "Grau de instrução", y = "Número de vínculos",
       caption = "Fonte: Observatório Portuário do Maranhão - Dados da RAIS 2020") +
  coord_flip() +
  theme_classic() +
  theme(plot.title = element_text(size = 16L, face = "bold"),
        plot.caption = element_text(size = 12L,face = "bold", hjust = 0), 
        axis.title.y = element_text(size = 14L, face = "bold"), 
        axis.title.x = element_text(size = 14L, face = "bold"),
        axis.text.x = element_text(size = 12L, face = "bold"),
        axis.text.y = element_text(size = 12L, face = "bold"),
        panel.grid.major.x  = element_line(color = "black", linetype = 3, size = 0.1),
        legend.position="top",
        legend.title = element_text(face = "bold")
        )+
  geom_text(aes(x = grau_instrucao_apos_2005, y = n, label= prettyNum(n, big.mark = ".", decimal.mark = ",")),
            position = position_dodge2(width = 1, reverse = T),
            size =4, vjust=.25, hjust = -.25,
           colour="black") +
  scale_y_continuous(breaks = seq(0,1200, 400), limits = c(0, 1200),
                     labels = number_format(big.mark = ".", decimal.mark = ",")) +
  scale_fill_manual(values = alpha(c("#32cdc2", "#FFBF47"), 1), name = "Sexo")

```

```{r g_adm_remuneracao_escol_sexo, results='hide', echo=FALSE, message=FALSE, warning=FALSE}

rais %>%
  filter(!is.na(grau_instrucao_apos_2005) & valor_remuneracao_media != 0.00 & subclasse == "5231101") %>%
  group_by(grau_instrucao_apos_2005, sexo, .groups = 'drop') %>% 
  summarise(n = n(),
            media = mean(valor_remuneracao_media)) %>% 
  mutate(grau_instrucao_apos_2005 = factor(grau_instrucao_apos_2005, levels = ordem_esc)) %>%
  ggplot(aes(x = grau_instrucao_apos_2005, y = media, fill = sexo)) +
  geom_bar(stat = "identity", 
          position=position_dodge2(reverse = T), 
           show.legend = T, color = "black") +
  labs(title = "Escolaridade dos profissionais que atuam na Administração da Infraestrutura Portuária\nno Brasil por sexo",
       x = "Grau de instrução", y = "Remuneração média",
       caption = "Fonte: Observatório Portuário do Maranhão - Dados da RAIS 2020") +
  coord_flip() +
  theme_classic() +
  theme(plot.title = element_text(size = 16L, face = "bold"),
        plot.caption = element_text(size = 12L,face = "bold", hjust = 0), 
        axis.title.y = element_text(size = 14L, face = "bold"), 
        axis.title.x = element_text(size = 14L, face = "bold"),
        axis.text.x = element_text(size = 12L, face = "bold"),
        axis.text.y = element_text(size = 12L, face = "bold"),
        panel.grid.major.x  = element_line(color = "black", linetype = 3, size = 0.1),
        legend.position="top",
        legend.title = element_text(face = "bold")
        )+
  geom_text(aes(x = grau_instrucao_apos_2005, y = media, label= prettyNum(media, big.mark = ".", decimal.mark = ",", digits = 1)),
            position = position_dodge2(width = 1, reverse = T),
            size =4, vjust=.25, hjust = -.05,
           colour="black") +
  scale_y_continuous(
    breaks = seq(0,16000, 5000), limits = c(0, 16000),
    labels = label_number(big.mark = ".", decimal.mark = ",",
                                            prefix = "R$ ")) +
  scale_fill_manual(values = alpha(c("#32cdc2", "#FFBF47"), 1), name = "Sexo")

```

## Raça ou cor

```{r g_adm_raca_sexo, results='hide', echo=FALSE, message=FALSE, warning=FALSE}

rais %>%
  filter(subclasse == "5231101") %>%
  group_by(raca_cor, sexo, .groups = 'drop') %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = raca_cor, y = n, fill = sexo)) +
  geom_bar(stat = "identity", 
          position=position_dodge2(reverse = TRUE), 
           show.legend = T, color = "black") +
  labs(title = "Quantidade dos profissionais que atuam na Administração da Infraestrutura Portuária no Brasil\npor raça ou cor e sexo",
       x = "Raça ou cor", y = "Número de vínculos",
       caption = "Fonte: Observatório Portuário do Maranhão - Dados da RAIS 2020") +
  coord_flip() +
  theme_classic() +
  theme(plot.title = element_text(size = 16L, face = "bold"),
        plot.caption = element_text(size = 12L,face = "bold", hjust = 0), 
        axis.title.y = element_text(size = 14L, face = "bold"), 
        axis.title.x = element_text(size = 14L, face = "bold"),
        axis.text.x = element_text(size = 12L, face = "bold"),
        axis.text.y = element_text(size = 12L, face = "bold"),
        panel.grid.major.x  = element_line(color = "black", linetype = 3, size = 0.1),
        legend.position="top",
        legend.title = element_text(face = "bold")
        )+
  geom_text(aes(x = raca_cor, y = n, label= prettyNum(n, big.mark = ".", decimal.mark = ",")),
            position = position_dodge2(width = 1, reverse = TRUE),
            size =4, vjust=.25, hjust = -.1,
           colour="black") +
  scale_y_continuous(breaks = seq(0,1200, 400), limits = c(0, 1200),
                     labels = number_format(big.mark = ".", decimal.mark = ",")) +
  scale_fill_manual(values = alpha(c("#32cdc2", "#FFBF47"), 1), name = "Sexo")

```


```{r g_adm_remuneracao_raca_sexo, results='hide', echo=FALSE, message=FALSE, warning=FALSE}

rais %>%
  filter(valor_remuneracao_media != 0.00  & subclasse == "5231101") %>%
  group_by(raca_cor, sexo, .groups = 'drop') %>% 
  summarise(n = n(),
            media = mean(valor_remuneracao_media)) %>% 
  ggplot(aes(x = raca_cor, y = media, fill = sexo)) +
  geom_bar(stat = "identity", 
          position=position_dodge2(reverse = T), 
           show.legend = T, color = "black") +
  labs(title = "Remuneração média dos profissionais que atuam na Administração da Infraestrutura Portuária\nno Brasil por raça ou cor e sexo",
       x = "Raça ou cor", y = "Remuneração média",
       caption = "Fonte: Observatório Portuário do Maranhão - Dados da RAIS 2020") +
  coord_flip() +
  theme_classic() +
  theme(plot.title = element_text(size = 16L, face = "bold"),
        plot.caption = element_text(size = 12L,face = "bold", hjust = 0), 
        axis.title.y = element_text(size = 14L, face = "bold"), 
        axis.title.x = element_text(size = 14L, face = "bold"),
        axis.text.x = element_text(size = 12L, face = "bold"),
        axis.text.y = element_text(size = 12L, face = "bold"),
        panel.grid.major.x  = element_line(color = "black", linetype = 3, size = 0.1),
        legend.position="top",
        legend.title = element_text(face = "bold")
        )+
  geom_text(aes(x = raca_cor, y = media, label= prettyNum(media, big.mark = ".", decimal.mark = ",", digits = 1)),
            position = position_dodge2(width = 1, reverse = T),
            size =4, vjust=.25, hjust = -.25,
           colour="black") +
  scale_y_continuous(
    breaks = seq(0,12000, 4000), limits = c(0, 15000),
    labels = label_number(big.mark = ".", decimal.mark = ",",
                                            prefix = "R$ ")) +
  scale_fill_manual(values = alpha(c("#32cdc2", "#FFBF47"), 1), name = "Raça ou cor")

```


## Ocupações

```{r g_adm_ocupacao, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
rais %>%
  filter(subclasse == "5231101") %>% 
  group_by(cbo_2002) %>% 
  summarise(n = n()) %>% 
  mutate(cbo_2002 = fct_reorder(cbo_2002, n)) %>% 
  arrange(desc(n)) %>% 
  top_n(10, n) %>% 
  ggplot(aes(x = cbo_2002, y = n))+
  geom_bar(fill = "lightblue", color = "#4682B4", position = "dodge", stat = "identity") +
  coord_flip() +
  labs(x = "Ocupação", y = "Número de vínculos",
         caption = "Fonte: Observatório Portuário do Maranhão - Dados da RAIS 2020") +
  ggtitle(
    "As 10 ocupações que com a maior quantidade de vínculos da Administração da\n Infraestrura Portuária  ", 
    subtitle = str_c(
      "São",
      rais %>% filter(subclasse == "5231101") %>% group_by(cbo_2002) %>% 
    summarise(n = n()) %>% select(n) %>% sum() %>% comma(big.mark = ".", decimal.mark = ","),
      "vínculos de trabalho em todo o país",
      sep = " ")) +
theme_classic() +
  theme(plot.title = element_text(size = 16L, face = "bold"),
        plot.caption = element_text(size = 12L,face = "bold", hjust = 0), 
        axis.title.y = element_text(size = 14L, face = "bold"), 
        axis.title.x = element_text(size = 14L, face = "bold"),
        axis.text.x = element_text(size = 12L, face = "bold"),
        axis.text.y = element_text(size = 12L, face = "bold"),
        panel.grid.major.x  = element_line(color = "black", linetype = 3, size = 0.1),
        legend.position = "none")+
  geom_text(aes(label= prettyNum(n, big.mark = ".", decimal.mark = ",")), 
            size =4,  
            hjust=2, vjust=0.5, colour="black") +
  scale_y_continuous(breaks = seq(0,650, 200), limits = c(0, 650),
                     labels = number_format(big.mark = ".", decimal.mark = ","))
  
```


## Municípios

```{r g_adm_municipio, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
rais %>%
  filter(subclasse == "5231101") %>% 
  group_by(nome_municipio) %>% 
  summarise(n = n()) %>% 
  mutate(nome_municipio = fct_reorder(nome_municipio, n)) %>% 
  arrange(desc(n)) %>% 
  top_n(20, n) %>% 
  ggplot(aes(x = nome_municipio, y = n))+
  geom_bar(fill = "lightblue", color = "black", position = "dodge", stat = "identity") +
  coord_flip() +
  labs(x = "Nome do município", y = "Número de vínculos",
         caption = "Fonte: Observatório Portuário do Maranhão - Dados da RAIS 2020") +
  ggtitle(
    "Os 20 municípios  com a maior quantidade de vínculos na Operação de\n Terminais Portuários", 
    subtitle = str_c(
      "São",
      rais %>% filter(subclasse == "5231102") %>% group_by(cbo_2002) %>% 
    summarise(n = n()) %>% select(n) %>% sum() %>% comma(big.mark = ".", decimal.mark = ","),
      "vínculos de trabalho em todo o país",
      sep = " ")) +
theme_classic() +
  theme(plot.title = element_text(size = 16L, face = "bold"),
        plot.caption = element_text(size = 12L,face = "bold", hjust = 0), 
        axis.title.y = element_text(size = 14L, face = "bold"), 
        axis.title.x = element_text(size = 14L, face = "bold"),
        axis.text.x = element_text(size = 12L, face = "bold"),
        axis.text.y = element_text(size = 12L, face = "bold"),
        panel.grid.major.x  = element_line(color = "black", linetype = 3, size = 0.1),
        legend.position = "none")+
  geom_text(aes(label= prettyNum(n, big.mark = ".", decimal.mark = ",")), 
            size =4,  
            hjust=-.5, vjust=0.5, colour="black") + 
  scale_y_continuous(breaks = seq(0,1000, 250), limits = c(0, 1000),
                     labels = number_format(big.mark = ".", decimal.mark = ","))
  
```
